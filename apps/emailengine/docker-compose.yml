version: "3.8"
services:
  postal:
    image: catdeployed/postal:alpine
    depends_on:
      - mariadb
      - rabbitmq
    entrypoint: ["/docker-entrypoint.sh"]
    volumes:
      - type: bind
        source: ./docker/ci-config
        target: /config
    ports:
      - ${APP_PORT}:80
    environment:
      POSTAL_CONFIG_ROOT: /config
      KATAPULT_CONFIG_FILE: /ci-config.yml
      WAIT_FOR_TIMEOUT: 90
      WAIT_FOR_TARGETS: |-
        mariadb:3306
        rabbitmq:5672
    labels:
      traefik.enable: true
      traefik.http.middlewares.postal-web-redirect.redirectscheme.scheme: https
      traefik.http.services.postal.loadbalancer.server.port: 80
      traefik.http.routers.postal-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.postal-insecure.entrypoints: web
      traefik.http.routers.postal-insecure.service: postal
      traefik.http.routers.postal-insecure.middlewares: postal-web-redirect
      traefik.http.routers.postal.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.postal.entrypoints: websecure
      traefik.http.routers.postal.service: postal
      traefik.http.routers.postal.tls.certresolver: myresolver
      traefik.http.routers.postal-local-insecure.rule: Host(`postal.${LOCAL_DOMAIN}`)
      traefik.http.routers.postal-local-insecure.entrypoints: web
      traefik.http.routers.postal-local-insecure.service: postal
      traefik.http.routers.postal-local-insecure.middlewares: postal-web-redirect
      traefik.http.routers.postal-local.rule: Host(`postal.${LOCAL_DOMAIN}`)
      traefik.http.routers.postal-local.entrypoints: websecure
      traefik.http.routers.postal-local.service: postal
      traefik.http.routers.postal-local.tls: true
    networks:
      - tipi_main_network

  mariadb:
    image: mariadb
    restart: always
    environment:
      MARIADB_DATABASE: postal
      MARIADB_ALLOW_EMPTY_PASSWORD: 'yes'
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: 'yes'
    networks:
      - tipi_main_network

  rabbitmq:
    image: rabbitmq:3
    restart: always
    networks:
      - tipi_main_network
